---
title: "Gene Expression Analysis"
author: Finn
output:
  html_document:
    toc: yes
    number_section: yes
    fig_caption: true
  pdf_document:
    toc: yes
  always_allow_html: true
date: "`r format(Sys.time(), '%d %B %Y')`"
---

# All Data we have on Gene Expression

If I am not mistaken, we have 2 separate people that worked on gene expression in the past:

- Svenja collected data with RTqPCR in 2016/17 for 88 samples (AA_0053 - AA_0465)

- Luke ran RTqPCRs again in 2021 for 327 samples, including all of Svenja's samples as well (AA_0053 - AA_0853)

```{r Load data and packages, echo = F, message=FALSE, }
library(tidyverse)
library(data.table)
library(psych)
library(knitr)
library(viridis)
library(RColorBrewer) #display.brewer.all()
library(colorRamps)
library(leaflet)
library(paletteer)
library(scico)
library(wesanderson)

basics          <- c("Mouse_ID", "Address", "Sex", "Longitude", 
                     "Latitude", "Year", "HI", "HI_NLoci")

gen.loci        <- c("mtBamH", "YNPAR", "X332", "X347", "X65", "Tsx", "Btk", "Syap1",
                     "Es1", "Gpd1", "Idh1", "Mpi", "Np", "Sod1", "Es1C", "Gpd1C",
                     "Idh1C", "MpiC", "NpC", "Sod1C", "HI_NLoci",
                     "HI", "Zfy2", "Y", "Region")

dissection.cols <- c("Body_Weight", "Body_Length", "Tail_Length", "Status", "Spleen", 
                     "Left_Testis", "Right_Testis", "Seminal_Vesicles_Weight", "Liver",
                     "Sperm", "Left_Epididymis", "Right_Epididymis", 
                     "Right_Ovarium_Weight", "Left_Ovarium_Weight",
                     "Left_Embryo", "Right_Embryo", "Fleas", "Ticks", "Ectoparasites_Logical", 
                     "Arrival", "Dissection_Date", "Trap_Date", "Host")

tissue.cols     <- c("SPL1", "SPL2", "ELFO", "LIV", "KI", "LUN", "SG",
                     "MES", "COWE", "COCE", "COCE2", "CEWE", "CECE", 
                     "ILWE", "SICE", "WEOH", "WFOR", "FEC")

initial.worms.cols   <- c("Aspiculuris","Syphacia_obvelata","Trichuris_muris", "Taenia_taeniformis", "Flea", "Ticks", "Fleas",
                             "Ectoparasites",    "Worms_presence", "Syphacia",
                             "Hymenolepis_diminiuta", "Hymenolepis_diminuta", "Taenia_martis",    "Heligmosomoides_polygurus" ,
                             "Heterakis_spumosa","Mastophorus_muris","Hymenolepis_microstoma", "Catenotaenia_pusilla",
                             "Cysticercus", "Hymenolepis", "Taenia", "Aspiculuris_Syphacia",  
                             "Trichuris", "Heterakis", "Mastophorus", "Ectoparasites_Logical", 
                             "Aspiculuris", "Catenotaenia_pusilla")

final.worms.cols <- c("Aspiculuris_sp", "Syphacia_sp", "Trichuris_muris", "Taenia_sp",
                      "Heterakis_sp", "Mastophorus_muris", "Hymenolepis_sp", "Catenotaenia_pusilla",
                      "Heligmosomoides_polygurus", "Worms_presence")

oocyst.cols     <- c("counter", "Feces_Weight", "Date_count", "N_oocysts_sq1",
                     "N_oocysts_sq2", "N_oocysts_sq3",  "N_oocysts_sq4",
                     "N_oocysts_sq5", "N_oocysts_sq6", "N_oocysts_sq7",
                     "N_oocysts_sq8", "mean_neubauer", "PBS_dil_in_mL", 
                     "OPG", "Ncells")

EqPCR.cols      <- c("delta_ct_ilwe_MminusE", "delta_ct_cewe_MminusE", "MC.Eimeria", "Ct.Eimeria", "Ct.Mus")

EimGeno.cols    <- c("n18S_Seq", "COI_Seq", "ORF470_Seq", "eimeriaSpecies")

Gene.Exp.cols   <- c("IFNy", "IL.12", "IRG6", "CXCR3", "IL.6", "GBP2",
                     "IL.10", "IL.13", "IL.10", "IL.13", "IL1RN",
                     "CXCR3", "CASP1", "CXCL9", 
                     "IDO1", "IRGM1", "MPO", "MUC2", "MUC5AC", "MYD88", 
                     "NCR1", "PRF1", "RETNLB", "SOCS1", "TICAM1", "TNF")

House.Keeping.cols <- c("GAPDH", "PPIB", "B.actin", "B-actin")

CellCount.cols <- c( "Treg", "CD4", "Treg17", "Th1", "Th17", "CD8",
                     "Act_CD8", "IFNy_CD4", "IL17A_CD4", "IFNy_CD8")

Crypto_qPCR.cols <- c("Ct_mean", "Oocyst_Predict", "ILWE_DNA_Content_ng.microliter")


# Load Palette ####
r <- c(0, 64, 128, 179, 217, 255)
g <- c(0, 12, 25, 25, 12,  0)
b <- c(255, 249, 243, 191,  95,   0)
  
beach <- function (n, name = c("beach.colors")) 
  {
    beach.colors = rgb(r,g,b,maxColorValue = 255)
    name = match.arg(name)
    orig = eval(parse(text = name))
    rgb = t(col2rgb(orig))
    temp = matrix(NA, ncol = 3, nrow = n)
    x = seq(0, 1, , length(orig))
    xg = seq(0, 1, , n)
    for (k in 1:3) {
      hold = spline(x, rgb[, k], n = n)$y
      hold[hold < 0] = 0
      hold[hold > 255] = 255
      temp[, k] = round(hold)
    }
    palette = rgb(temp[, 1], temp[, 2], temp[, 3], maxColorValue = 255)
    palette
}


GENE_TABLE <- read.csv("https://raw.githubusercontent.com/tlobnow/Cryptosporidium-BSc/Main-Branch/Markdown_Reports/GEA_Genes.csv")

SOTA <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/SOTA_Data_Product.csv") %>% select(-X)

#### 2016-2019 (Luke)
IFC1 <- read.csv("https://raw.githubusercontent.com/derele/Eimeria_Lab/master/data/Experiment_results/IFC1.csv")
IFC2 <- read.csv("https://raw.githubusercontent.com/derele/Eimeria_Lab/master/data/Experiment_results/IFC2.csv")
IFC3 <- read.csv("https://raw.githubusercontent.com/derele/Eimeria_Lab/master/data/Experiment_results/IFC3.csv")
IFC4 <- read.csv("https://raw.githubusercontent.com/derele/Eimeria_Lab/master/data/Experiment_results/IFC4.csv")
IFC5 <- read.csv("https://raw.githubusercontent.com/derele/Eimeria_Lab/master/data/Experiment_results/IFC5.csv")
IFC  <- bind_rows(IFC1, IFC2, IFC3, IFC4, IFC5)
rm(IFC1)
rm(IFC2)
rm(IFC3)
rm(IFC4)
rm(IFC5)

## adjust IDs
colnames(IFC)[colnames(IFC)%in%"EH_ID"] <- "Mouse_ID"
IFC$Mouse_ID <- gsub(pattern = "A", replacement = "AA_", x = IFC$Mouse_ID)
IFC$Mouse_ID <- gsub(pattern = "AA_AA_", replacement = "AA_", x = IFC$Mouse_ID)
IFC$Mouse_ID <- gsub(pattern = "LM", replacement = "LM_", x = IFC$Mouse_ID)
## filter out LM_XXXX
IFC <- IFC[IFC$Mouse_ID %like% "AA_", ]

## remove unsuccessful amplifications 
## == 999, equivalent to bad quality, should not be used
## Luke's Version:
IFC <- subset(IFC, IFC$Value != 999)
IFC <- IFC %>% group_by(Mouse_ID, Target) %>% summarise(Ct = mean(Value)) 
IFC <- distinct(IFC)

## separate data using the pivot_wider()
## turns Gene Expression Markers into individual columns (from Target),
## values taken (from Ct)
IFC <- pivot_wider(IFC, names_from = "Target", values_from = "Ct")

## We need to add Variance and n() again - if I add variance before pivoting, 
# it will lead to numerous lines, because we have numerous variances for the different markers, 
# same for the n()... either we create a variance variable for EACH marker individually 
# or we don't include it for the pivoting... 




## rename columns that have incorrect column names
colnames(IFC)[colnames(IFC)%in%"IL6"]   <- "IL.6"
colnames(IFC)[colnames(IFC)%in%"IL10"]  <- "IL.10"
colnames(IFC)[colnames(IFC)%in%"IL12A"]  <- "IL.12A"
colnames(IFC)[colnames(IFC)%in%"IL13"]  <- "IL.13"
colnames(IFC)[colnames(IFC)%in%"IL17A"]  <- "IL.17A"
colnames(IFC)[colnames(IFC)%in%"IFNG"]  <- "IFNy"

#### NORMALIZING GENE EXPRESSION WITH HOUSEKEEPING GENES
# Luke used 2 housekeeping genes for normalization, B-PPIB and GAPDH
# in order to normalize for these two, we will take the geometric mean and
# subtract that number per each individual mouse
IFC_NE <- IFC %>% mutate(Norm =  geometric.mean(IFC$GAPDH, na.rm = TRUE), # building geometric mean
                         CASP1 =   Norm - CASP1,
                         CXCL9 =   Norm - CXCL9,
                         CXCR3 =   Norm - CXCR3,
                         IDO1  =   Norm - IDO1,
                         IFNy  =   Norm - IFNy,
                         IL.6  =   Norm - IL.6,
                         IL.10 =   Norm - IL.10,
                         IL.12A =  Norm - IL.12A,
                         IL.13  =  Norm - IL.13,
                         IL.17A =  Norm - IL.17A,
                         IL1RN =   Norm - IL1RN,
                         IRGM1 =   Norm - IRGM1,
                         MPO   =   Norm - MPO,
                         MUC2  =   Norm - MUC2,
                         MUC5AC =  Norm - MUC5AC,
                         MYD88  =  Norm - MYD88,
                         NCR1   =  Norm - NCR1,
                         PRF1   =  Norm - PRF1,
                         RETNLB =  Norm - RETNLB,
                         SOCS1  =  Norm - SOCS1,
                         TICAM1 =  Norm - TICAM1,
                         TNF    =  Norm - TNF)
```


## Housekeeping Genes
Housekeeping genes are generally used to differentiate actual immune response to a stimulus (in our case infections with parasites) from normal gene expression. Expression of HK genes is constant in natural and stimulated state.

- Svenja used:
  - B.Actin ( _actb_ in literature I have seen)
  - GAPDH
- Luke used:
  - PPIB
  - GAPDH

Since Luke redid all the samples and the protocol included pre-amplification, the results from Svenja are not comparable to Luke's. Therefore, only results from Luke will be used for further analysis.

Samples lost in Luke's IFC run:
- AA_0072
- AA_00432


## Use of HK genes

1. build the geometric mean of all GAPDH values from all samples with _psych_ package
      ` GAPDH_Norm = geometric.mean(SOTA$GAPDH, na.rm = TRUE) `


2. subtract immuno gene values from the Norm

      ` Normalized_Value = GAPDH_Norm - Immuno_Gene `
    
    
## Immune Response Genes of Interest (GOI)

```{r all-Genes, echo = F}
kable(GENE_TABLE)
```


# Table of normalized Gene Expression Values
```{r SOTA-Norm-Table, echo = F}
vis_Genes <- SOTA[colnames(SOTA) %in% c("Mouse_ID", "HI", Gene.Exp.cols, EqPCR.cols, EimGeno.cols, House.Keeping.cols, Crypto_qPCR.cols, "OPG")]

vis_Genes$eimeriaSpecies[grep("Negative*.", vis_Genes$eimeriaSpecies)] <- NA

vis_Genes <- vis_Genes %>% 
    mutate(GEA_Performed = case_when(GAPDH > 0 ~ T, PPIB > 0 ~ T),
           Tested_for = case_when(Ct_mean >= 0 & is.na(Ct.Eimeria) & is.na(eimeriaSpecies) ~ "Crypto",
                                is.na(Ct_mean) & !is.na(eimeriaSpecies) ~ "Eimeria",
                                is.na(Ct_mean) & (!is.na(Ct.Eimeria) | !is.na(eimeriaSpecies)) ~ "Eimeria",
                                !is.na(Ct_mean) & (!is.na(Ct.Eimeria) | !is.na(eimeriaSpecies)) ~ "Crypto_Eimeria",
                                is.na(Ct_mean) & is.na(Ct.Eimeria) & is.na(eimeriaSpecies) ~ "none",
                                is.na(Ct_mean) & (is.na(Ct.Eimeria) | is.na(eimeriaSpecies)) ~ "none"),
         Crypto_Positive  = case_when(Ct_mean > 0 ~ T,
                                      Ct_mean == 0 ~ F),
         Eimeria_Positive = case_when(eimeriaSpecies != "Negative" | Ct.Eimeria > 0 | OPG > 0 ~ T,
                                      eimeriaSpecies == "Negative" | Ct.Eimeria == 0 | OPG == 0 ~ F),
         Infection = case_when(Tested_for == "Crypto" & Ct_mean > 0                                                          ~ "Positive Crypto",
                               Tested_for == "Crypto" & Ct_mean == 0                                                         ~ "Negative Crypto",
                               Tested_for == "Eimeria" & Eimeria_Positive == T                                               ~ "Positive Eimeria",
                               Tested_for == "Eimeria" & Eimeria_Positive == F                                               ~ "Negative Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean > 0  & (Ct.Eimeria > 0 |  eimeriaSpecies != "Negative" | OPG > 0) ~ "Positive Crypto_Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean > 0  & (Ct.Eimeria == 0 | eimeriaSpecies == "Negative"| OPG == 0) ~ "Positive Crypto",
                               Tested_for == "Crypto_Eimeria" & Ct_mean == 0 & (Ct.Eimeria > 0 | eimeriaSpecies != "Negative" | OPG > 0)  ~ "Positive Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean == 0 & (Ct.Eimeria == 0 | eimeriaSpecies == "Negative" | OPG == 0) ~ "Negative Crypto_Eimeria",
                               Tested_for == "none" ~ "not tested"),
           Infected = case_when(Infection == "not tested" ~ F,
                              Infection == "Negative Crypto" ~ F,
                              Crypto_Positive == T | Eimeria_Positive == T ~ T,
                              Crypto_Positive == F & Eimeria_Positive == F ~ F,
                              is.na(Crypto_Positive) & Eimeria_Positive == F ~ F,
                              Crypto_Positive == F & is.na(Eimeria_Positive) ~ F,
                              ),
         Eim_Uninfected = case_when(MC.Eimeria == F & OPG == 0 ~ T)) %>%
    filter(GEA_Performed == T)
kable(vis_Genes[1:30,c(1,9:30)])

# no filter: 326 Samples

# is.na(MC.Eimeria): 147 Observations
# MC.Eimeria == T: 92
# MC.Eimeria == F: 87
```

# Visualization of normalized Gene Expression Values vs. Infection Intensity
## normalized Gene Expression Values vs. Infection Intensity

```{r SOTA-Norm-Vis-Delta_Ct-1, echo = F, message=F, warning=F}
vis_Genes %>%
  filter(MC.Eimeria == T,
         Infection != "not tested") %>%
  pivot_longer(cols = c(9:30, -IFNy, - GAPDH, -PPIB), names_to = "Marker", values_to = "Value") %>%
  ggplot(aes(delta_ct_cewe_MminusE, Value, col = eimeriaSpecies)) +
  geom_point() +
  geom_smooth(method = NULL, aes(col = "")) +
  facet_wrap(~Marker) +
  ggtitle("Infection Intensity vs. Gene Expression Value, colored by Species") +
  labs(x = "Infection Intensity (Delta_Ct)", y = "Gene Expression Value")

```

## Same but with method == lm
```{r SOTA-Norm-Vis-Delta_Ct-2, echo = F, message=F, warning=F}
vis_Genes %>% 
  filter(MC.Eimeria == T) %>%
  pivot_longer(cols = c(9:30, -IFNy, - GAPDH, -PPIB), names_to = "Marker", values_to = "Value") %>%
  ggplot(aes(delta_ct_cewe_MminusE, Value, col = eimeriaSpecies)) +
  geom_point() +
  geom_smooth(method = lm, aes(col = "")) +
  facet_wrap(~Marker, scales = "free_y") +
  ggtitle("Infection Intensity vs. Gene Expression Value, colored by Species") +
  labs(x = "Infection Intensity (Delta_Ct)", y = "Gene Expression Value")
```

## Gene Expression Values vs. HI

```{r SOTA-Norm-Vis-HI, echo = F, message=F, warning=F}

vis_Genes %>%
  pivot_longer(cols = c(9:30, -IFNy, - GAPDH, -PPIB), names_to = "Marker", values_to = "Value") %>%
  ggplot(aes(HI, Value, col = HI, alpha = 0.3)) +
  geom_point() +
  geom_smooth(method = NULL) +
  facet_wrap(~Marker) +
  theme(legend.position = "none")  +
  scale_color_gradient(low = "blue", high = "red") +
  ggtitle("HI vs. Gene Expression Value") +
  labs(x = "HI", y = "Gene Expression Value")
```