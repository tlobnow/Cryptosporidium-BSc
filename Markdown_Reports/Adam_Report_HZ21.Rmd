---
title: "Report_HZ21"
author: tlobnow
output:
  html_document:
    toc: yes
    number_section: yes
  pdf_document:
    toc: yes
  always_allow_html: true
date: "`r format(Sys.time(), '%d %B %Y')`"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.align = 'center', echo = TRUE)
```

```{r libs, include = FALSE}
library(tidyverse)
library(data.table)
library(leaflet)
library(ggplot2)
library(RColorBrewer) #display.brewer.all()
library(colorRamps)
library(cowplot)
library(uwot)
library(leaflet.extras)
library(sp)
library(htmltools)
library(stringr)
library(patchwork)
library(readr)
library(knitr)
library(ggeffects)
#library(parasiteLoad)

SOTA <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/SOTA_Data_Product.csv") %>% select(-X)
Crypto_Detection <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X)


# Load Palette ####
r <- c(0, 64, 128, 179, 217, 255)
g <- c(0, 12, 25, 25, 12,  0)
b <- c(255, 249, 243, 191,  95,   0)
  
beach <- function (n, name = c("beach.colors")) 
  {
    beach.colors = rgb(r,g,b,maxColorValue = 255)
    name = match.arg(name)
    orig = eval(parse(text = name))
    rgb = t(col2rgb(orig))
    temp = matrix(NA, ncol = 3, nrow = n)
    x = seq(0, 1, , length(orig))
    xg = seq(0, 1, , n)
    for (k in 1:3) {
      hold = spline(x, rgb[, k], n = n)$y
      hold[hold < 0] = 0
      hold[hold > 255] = 255
      temp[, k] = round(hold)
    }
    palette = rgb(temp[, 1], temp[, 2], temp[, 3], maxColorValue = 255)
    palette
  }
```

# qPCR Results

```{r qPCR results, echo = F}
Crypto_Detection <- Crypto_Detection %>% 
  filter(Year == 2021,
         Ct_mean > 0) %>% 
  select(Mouse_ID, Ct_mean, Oocyst_Predict, Latitude, Longitude) %>% arrange(desc(Oocyst_Predict))

kable(Crypto_Detection,
      col.names = c("Mouse_ID", "Ct_mean", "Oocyst_Predict", "Latitude", "Longitude"),
      align = "ccc",
      caption = "Table 1: _Cryptosporidium_-positive samples from 2021, arranged by Ct_mean")
```

# Model for predicting Oocysts

The linear model was designed as: lm(log2(Amount_Oocysts) \~ Ct_mean, data = Standard_Curve)

The Oocyst Prediction was then calculated as: 2\^predict(linear_model0, newdata = Crypto_Detection)

```{r OP_Model, echo = F}
Standard_Curve <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_input/Cryptosporidium/Crypto_Standard_Curve.csv")

Standard_Curve     <-  filter(Standard_Curve, Ct_mean > 0)
linear_model0     <- lm(log2(Amount_Oocysts) ~ Ct_mean, data = Standard_Curve)
Oocyst_Predict    <- 2^predict(linear_model0, newdata = Crypto_Detection)
Crypto_qPCR <- data.frame(Crypto_Detection, Oocyst_Predict)
Crypto_qPCR <- Crypto_qPCR %>% mutate(Oocyst_Predict = replace(Oocyst_Predict, Oocyst_Predict == "4292821751815.77", "0"))
Crypto_qPCR$Oocyst_Predict <- as.integer(Crypto_qPCR$Oocyst_Predict)
```

# Hybrid Index Mapping

Hybrid Index for samples from previous years (as 2021 host genotyping data is not available yet) gives an outline of the hybrid zone area (light purple background).

```{r mini map HI , echo = F, message = F, warning = F}
SOTA <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/SOTA_Data_Product.csv") %>% select(-X) %>% filter(!is.na(Latitude), !is.na(Longitude), !is.na(HI), Mouse_ID != "SK_2697")
#SOTA <- SOTA[SOTA$Mouse_ID %like% "AA_", ]


Crypto_Detection_tested <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Ct_mean >= 0, !is.na(Latitude), !is.na(Longitude), !is.na(HI))

Crypto_Detection <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Ct_mean > 0, !is.na(Latitude), !is.na(Longitude), !is.na(HI))


Crypto_Detection_21 <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Year == 2021, Ct_mean > 0, !is.na(Latitude), !is.na(Longitude))


SOTA <- SOTA %>%
  mutate(Eim_Species = ifelse(eimeriaSpecies == "E_falciformis", "E_falciformis",
                              ifelse(eimeriaSpecies == "E_ferrisi", "E_ferrisi",
                                     ifelse(eimeriaSpecies == "Eimeria_alorani", "Eimeria_alorani",
                                            ifelse(eimeriaSpecies == "Eimeria_apionodes", "Eimeria_apionodes",
                                                   ifelse(eimeriaSpecies == "Eimeria_falciformis", "Eimeria_falciformis",
                                                          ifelse(eimeriaSpecies == "Eimeria_sp_Apodemus", "Eimeria_sp_Apodemus",
                                                                 ifelse(eimeriaSpecies == "Eimeria_vermiformis", "Eimeria_vermiformis",
                                                                        ifelse(eimeriaSpecies == "Negative", "Negative",
                                                                               ifelse(NA)))))))))) %>%
  mutate(Tested_for = case_when(Ct_mean >= 0 & is.na(Ct.Eimeria) & is.na(Eim_Species) ~ "Crypto",
                                is.na(Ct_mean) & !is.na(Eim_Species) ~ "Eimeria",
                                is.na(Ct_mean) & (!is.na(Ct.Eimeria) | !is.na(Eim_Species)) ~ "Eimeria",
                                !is.na(Ct_mean) & (!is.na(Ct.Eimeria) | !is.na(Eim_Species)) ~ "Crypto_Eimeria",
                                is.na(Ct_mean) & is.na(Ct.Eimeria) & is.na(Eim_Species) ~ "none",
                                is.na(Ct_mean) & (is.na(Ct.Eimeria) | is.na(Eim_Species)) ~ "none"),
         Crypto_Positive  = case_when(Ct_mean > 0 ~ T,
                                      Ct_mean == 0 ~ F),
         Eimeria_Positive = case_when(Eim_Species != "Negative" | Ct.Eimeria > 0 | OPG > 0 ~ T,
                                      Eim_Species == "Negative" | Ct.Eimeria == 0 | OPG == 0 ~ F),
         Infection = case_when(Tested_for == "Crypto" & Ct_mean > 0                                                          ~ "Positive Crypto",
                               Tested_for == "Crypto" & Ct_mean == 0                                                         ~ "Negative Crypto",
                               Tested_for == "Eimeria" & Eimeria_Positive == T                                               ~ "Positive Eimeria",
                               Tested_for == "Eimeria" & Eimeria_Positive == F                                               ~ "Negative Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean > 0  & (Ct.Eimeria > 0 |  Eim_Species != "Negative" | OPG > 0) ~ "Positive Crypto_Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean > 0  & (Ct.Eimeria == 0 | Eim_Species == "Negative"| OPG == 0) ~ "Positive Crypto",
                               Tested_for == "Crypto_Eimeria" & Ct_mean == 0 & (Ct.Eimeria > 0 | Eim_Species != "Negative" | OPG > 0)  ~ "Positive Eimeria",
                               Tested_for == "Crypto_Eimeria" & Ct_mean == 0 & (Ct.Eimeria == 0 | Eim_Species == "Negative" | OPG == 0) ~ "Negative Crypto_Eimeria",
                               Tested_for == "none" ~ "not tested"),
         Infected = case_when(Infection == "not tested" ~ F,
                              Infection == "Negative Crypto" ~ F,
                              Crypto_Positive == T | Eimeria_Positive == T ~ T,
                              Crypto_Positive == F & Eimeria_Positive == F ~ F,
                              is.na(Crypto_Positive) & Eimeria_Positive == F ~ F,
                              Crypto_Positive == F & is.na(Eimeria_Positive) ~ F,
                              ))


map <- Crypto_Detection_21 %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  setView(lat = 52.520007, lng =13.404954, zoom = 8)

# Cutting
SOTA$HI <- as.numeric(SOTA$HI)
SOTA$HI_Level <-  cut(SOTA$HI, c(0, 0.001, 0.250, 0.500, 0.750, 0.999, 1), include.lowest = T , labels = c('HI = 0', 'HI < 0.25', 'HI < 0.5', 'HI < 0.75', 'HI < 1', 'HI = 1'))
Crypto_Detection_21$Ct_Level <- cut(Crypto_Detection_21$Ct_mean, c(1, 28, 30, 32, 34, 36, 40), include.lowest = F , labels = c(' < 28  ', '28 - 30', '30 - 32', '32 - 34', '34 - 36', ' > 36'))

data_col_HI       = colorFactor(beach(6), SOTA$HI)
data_col_HI_Level = colorFactor(beach(6), SOTA$HI_Level)
data_col_Ct_Level = colorFactor(brewer.pal(4, "YlOrRd"), Crypto_Detection_21$Ct_Level, reverse = T)
data_col_Eim_Infected = colorFactor(brewer.pal(3, "YlOrRd"), SOTA$Eimeria_Positive)


Ct_bl_30   <- Crypto_Detection_21 %>% filter(Ct_mean <= 30 & Ct_mean > 0)
Ct_bl_34   <- Crypto_Detection_21 %>% filter(Ct_mean <= 34 & Ct_mean > 30)
Ct_bl_36   <- Crypto_Detection_21 %>% filter(Ct_mean <= 36 & Ct_mean > 34)
Ct_over_36 <- Crypto_Detection_21 %>% filter(Ct_mean > 36)
EIM_INFECTED <- SOTA %>% filter(Eimeria_Positive == T)
SOTA <- SOTA %>% filter(!is.na(HI))


map %>%
  addPolylines(lat = c(55.0000, 53.6000, 53.51885, 52.8875  , 52.6053, 51.8978, 45.0000), lng = c(10.0000, 11.4563, 12.4464,13.8119 , 13.8756, 13.8103, 13.5000), color = "purple", weight = 55, opacity = 0.1) %>%
  addCircleMarkers(data = SOTA,
                   col = ~data_col_HI(HI),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>",as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>HI:<b>",      as.character(HI), "<br>",
                                  "<b>Year:<b>",    as.character(Year),"<br>",
                                  "<b>Ct:<b>",      as.character(Ct_mean),"<br>",
                                  "<b>Oocysts:<b>", as.character(Oocyst_Predict), "<br>",
                                  "<b>Sex:<b>", Sex, "<br>",
                                  sep=" "),
                   opacity = 1,
                   radius = 3,
                   group = "Samples (total)") %>%
  addCircleMarkers(data = Crypto_Detection_tested,
                   col = ~data_col_HI(HI),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>",as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>HI:<b>",      as.character(HI), "<br>",
                                  "<b>Year:<b>",    as.character(Year),"<br>",
                                  "<b>Ct:<b>",      as.character(Ct_mean),"<br>",
                                  "<b>Oocysts:<b>", as.character(Oocyst_Predict), "<br>",
                                  "<b>Sex:<b>", Sex, "<br>",
                                  sep=" "),
                   opacity = 1,
                   radius = 3,
                   group = "Samples (Crypto-tested)") %>%
  addCircleMarkers(data = Crypto_Detection,
                   col = ~data_col_HI(HI),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>",as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>HI:<b>",      as.character(HI), "<br>",
                                  "<b>Year:<b>",    as.character(Year),"<br>",
                                  "<b>Ct:<b>",      as.character(Ct_mean),"<br>",
                                  "<b>Oocysts:<b>", as.character(Oocyst_Predict), "<br>",
                                  "<b>Sex:<b>", Sex, "<br>",
                                  sep=" "),
                   opacity = 1,
                   radius = 3,
                   group = "Samples (Crypto-positive)") %>%

  addLegend("bottomleft", 
            pal = data_col_HI_Level, 
            title = "HI",
            values = SOTA$HI_Level, 
            group = c('HI = 0', 'HI < 0.25', 'HI < 0.5', 'HI < 0.75', 'HI < 1', 'HI = 1'),
            opacity = 1) %>%
addLayersControl(baseGroups = c("Samples (total)", "Samples (Crypto-tested)", "Samples (Crypto-positive)"), 
                 options = layersControlOptions(collapsed = F))

```


# Positive Samples from 2021 qPCRs

Geographic distribution of Crypto-positive samples. Color and size indicate Ct (bigger/darker == lower Ct value)

Clicking on specific samples reveals Mouse_ID, Location details, amount of caught mice at the location and ratio of Crypto-infected individuals, as well as the oocyst prediction (as described above).


```{r mini map positive samples, echo = F, message = F, warning = F}
Crypto_Detection <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Ct_mean > 0, !is.na(Latitude), !is.na(Longitude), !is.na(HI))

Crypto_Detection_21 <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Year == 2021, Ct_mean > 0, !is.na(Latitude), !is.na(Longitude))

map <- Crypto_Detection_21 %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  setView(lat = 52.520007, lng =13.404954, zoom = 8)

# Cutting
Crypto_Detection$HI <- as.numeric(Crypto_Detection$HI)
Crypto_Detection$HI_Level <-  cut(Crypto_Detection$HI, c(0, 0.001, 0.250, 0.500, 0.750, 0.999, 1), include.lowest = T , labels = c('HI = 0', 'HI < 0.25', 'HI < 0.5', 'HI < 0.75', 'HI < 1', 'HI = 1'))
Crypto_Detection_21$Ct_Level <- cut(Crypto_Detection_21$Ct_mean, c(1, 28, 30, 32, 34, 36, 40), include.lowest = F , labels = c(' < 28  ', '28 - 30', '30 - 32', '32 - 34', '34 - 36', ' > 36'))

data_col_HI       = colorFactor(beach(6), Crypto_Detection$HI)
data_col_HI_Level = colorFactor(beach(6), Crypto_Detection$HI_Level)
data_col_Ct_Level = colorFactor(brewer.pal(4, "YlOrRd"), Crypto_Detection_21$Ct_Level, reverse = T)
data_col_Sampled  = colorFactor(brewer.pal(6, "Accent"), SOTA$Year)

Ct_bl_30   <- Crypto_Detection_21 %>% filter(Ct_mean <= 30 & Ct_mean > 0)
Ct_bl_34   <- Crypto_Detection_21 %>% filter(Ct_mean <= 34 & Ct_mean > 30)
Ct_bl_36   <- Crypto_Detection_21 %>% filter(Ct_mean <= 36 & Ct_mean > 34)
Ct_over_36 <- Crypto_Detection_21 %>% filter(Ct_mean > 36)

map %>%
  addPolylines(lat = c(55.0000, 53.6000, 53.51885, 52.8875  , 52.6053, 51.8978, 45.0000), lng = c(10.0000, 11.4563, 12.4464,13.8119 , 13.8756, 13.8103, 13.5000), color = "purple", weight = 55, opacity = 0.1) %>%
  addCircleMarkers(data = Ct_over_36, 
                   col = ~data_col_Ct_Level(Ct_Level),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = 4,
                   opacity = 5,
                   group = "Ct_over_36") %>%
  addCircleMarkers(data = Ct_over_36, 
                   col = ~data_col_Ct_Level(Ct_Level),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = 5,
                   opacity = 5,
                   group = "Ct_over_36") %>%
  addCircleMarkers(data = Ct_bl_36, 
                   col = ~data_col_Ct_Level(Ct_Level),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = 6,
                   opacity = 5,
                   group = "Ct_bl_36") %>%
  addCircleMarkers(data = Ct_bl_34, 
                   label = ~htmlEscape(Mouse_ID),
                   col = ~data_col_Ct_Level(Ct_Level),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = 7,
                   opacity = 5,
                   group = "Ct_bl_34") %>%
  addCircleMarkers(data = Ct_bl_30, 
                   label = ~htmlEscape(Mouse_ID),
                   col = ~data_col_Ct_Level(Ct_Level),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = 8,
                   opacity = 5,
                   group = "Ct_bl_30") %>%
  addLegend("bottomleft", 
            pal = data_col_Ct_Level, 
            title = "Ct",
            values = Crypto_Detection_21$Ct_Level, 
            group = c("Ct_bl_30", "Ct_bl_34", "Ct_bl_36", "Ct_over_36"),
            opacity = 1)
```

```{r mini map Eimeria-Infections Past, echo = F, message = F, warning = F}
Crypto_Detection <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Ct_mean > 0, !is.na(Latitude), !is.na(Longitude), !is.na(HI))

Crypto_Detection_21 <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/Crypto_Detection.csv") %>% select(-X) %>% filter(Year == 2021, Ct_mean > 0, !is.na(Latitude), !is.na(Longitude))

SOTA <- read.csv("https://raw.githubusercontent.com/derele/Mouse_Eimeria_Field/master/data_products/SOTA_Data_Product.csv") %>% select(-X)

map <- Crypto_Detection_21 %>%
  leaflet() %>%
  addProviderTiles("CartoDB") %>%
  setView(lat = 52.6967 , lng =14.0833, zoom = 10)

# Cutting
Crypto_Detection$HI <- as.numeric(Crypto_Detection$HI)
Crypto_Detection$HI_Level <-  cut(Crypto_Detection$HI, c(0, 0.001, 0.250, 0.500, 0.750, 0.999, 1), include.lowest = T , labels = c('HI = 0', 'HI < 0.25', 'HI < 0.5', 'HI < 0.75', 'HI < 1', 'HI = 1'))
Crypto_Detection_21$Ct_Level <- cut(Crypto_Detection_21$Ct_mean, c(1, 28, 30, 32, 34, 36, 40), include.lowest = F , labels = c(' < 28  ', '28 - 30', '30 - 32', '32 - 34', '34 - 36', ' > 36'))

data_col_HI       = colorFactor(beach(6), Crypto_Detection$HI)
data_col_HI_Level = colorFactor(beach(6), Crypto_Detection$HI_Level)
data_col_Ct_Level = colorFactor(brewer.pal(4, "YlOrRd"), Crypto_Detection_21$Ct_Level, reverse = T)
data_col_Sampled  = colorFactor(brewer.pal(6, "Accent"), SOTA$Year)

Ct_bl_30   <- Crypto_Detection_21 %>% filter(Ct_mean <= 30 & Ct_mean > 0)
Ct_bl_34   <- Crypto_Detection_21 %>% filter(Ct_mean <= 34 & Ct_mean > 30)
Ct_bl_36   <- Crypto_Detection_21 %>% filter(Ct_mean <= 36 & Ct_mean > 34)
Ct_over_36 <- Crypto_Detection_21 %>% filter(Ct_mean > 36)
Crypto_Positives_21 <- Crypto_Detection_21 %>% filter(Ct_mean > 28)
Sampled <- SOTA %>% filter(!is.na(Year), Year != 2021)




map %>%
  addPolylines(lat = c(55.0000, 53.6000, 53.51885, 52.8875  , 52.6053, 51.8978, 45.0000), lng = c(10.0000, 11.4563, 12.4464,13.8119 , 13.8756, 13.8103, 13.5000), color = "purple", weight = 55, opacity = 0.1) %>%
  addCircleMarkers(data = Sampled,
                   col = "#351c75",
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>",as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>HI:<b>",      as.character(HI), "<br>",
                                  "<b>Year:<b>",    as.character(Year),"<br>",
                                  "<b>Ct:<b>",      as.character(Ct_mean),"<br>",
                                  "<b>Oocysts:<b>", as.character(Oocyst_Predict), "<br>",
                                  "<b>Sex:<b>", Sex, "<br>",
                                  sep=" "),
                   opacity = 0.3,
                   radius = 3,
                   group = "Sample Locations") %>%
  addCircleMarkers(data = EIM_INFECTED,
                   col = "#72cac3",
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>",as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>HI:<b>",      as.character(HI), "<br>",
                                  "<b>Year:<b>",    as.character(Year),"<br>",
                                  "<b>Ct:<b>",      as.character(Ct_mean),"<br>",
                                  "<b>Oocysts:<b>", as.character(Oocyst_Predict), "<br>",
                                  "<b>Sex:<b>", Sex, "<br>",
                                  sep=" "),
                   opacity = 0.3,
                   radius = sqrt((EIM_INFECTED$delta_ct_cewe_MminusE)^2),
                   group = "EIM_INFECTED") %>%
  addCircleMarkers(data = Crypto_Positives_21, 
                   color = ~data_col_Ct_Level(Ct_Level),
                   label = ~htmlEscape(Mouse_ID),
                   popup = ~paste("<b>Mouse_ID:<b>", as.character(Mouse_ID), "<br>",
                                  "<b>Location:<b>", as.character(Latitude), "<b>,<b>", as.character(Longitude), "<br>",
                                  "<b>Crypto Infections:<b>",  as.character(Crypto_mus_caught), "<b>/<b>", as.character(mus_caught), "<br>",
                                  "<b>Oocyst Prediction:<b>",  as.character(Oocyst_Predict), "<br>",
                                  sep=" "),
                   radius = (Crypto_Positives_21$Oocyst_Predict)/1000,
                   #opacity = (Crypto_Positives_21$Ct_mean),
                   opacity = (Crypto_Positives_21$Oocyst_Predict)/1000,
                   group = "Crypto Positives 2021") %>%
  addLayersControl(overlayGroups = c("Sample Locations", "EIM_INFECTED"),
                   baseGroups = c("Crypto Positives 2021"),
                 options = layersControlOptions(collapsed = F)) %>%
  addLegend("bottomleft", 
            pal = data_col_Ct_Level, 
            title = "Ct",
            values = Crypto_Detection_21$Ct_Level, 
            group = c("Crypto Positives 2021"),
            opacity = 1)
```